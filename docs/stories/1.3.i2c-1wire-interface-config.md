# Story 1.3: I2C and 1-Wire Interface Configuration

## Status
Ready

## Story
**As a** developer,
**I want** I2C and 1-Wire interfaces enabled on Raspberry Pi,
**so that** I can communicate with digital sensors (STEMMA Soil, BH1750, DHT20, DS18B20).

## Acceptance Criteria
1. I2C interface enabled via `raspi-config` ‚Üí Interface Options ‚Üí I2C
2. 1-Wire interface enabled via `raspi-config` ‚Üí Interface Options ‚Üí 1-Wire
3. I2C tools installed (`sudo apt install i2c-tools`)
4. I2C bus scanned successfully (`i2cdetect -y 1`) - even without sensors connected yet, command runs without error
5. 1-Wire device tree overlay loaded (verified in `/boot/config.txt` or `/boot/firmware/config.txt`)

## Tasks / Subtasks

**‚ö†Ô∏è NOTE: Requires SSH access to Raspberry Pi (completed in Story 1.2)**

**ü§ñ PART 1: CREATE REPO INFRASTRUCTURE FILES (Infrastructure-as-Code)**

- [ ] Create automation script for enabling interfaces
  - [ ] Create directory: `setup/raspberry-pi/scripts/` (if not exists)
  - [ ] Create file: `setup/raspberry-pi/scripts/enable-interfaces.sh`
  - [ ] Script contents:
    - Check if I2C already enabled (idempotent)
    - Check if 1-Wire already enabled (idempotent)
    - Detect boot config location (`/boot/config.txt` vs `/boot/firmware/config.txt`)
    - Add `dtparam=i2c_arm=on` if missing
    - Add `dtoverlay=w1-gpio` if missing
    - Install `i2c-tools` if not installed
    - Output success/failure messages
  - [ ] Make executable: `chmod +x setup/raspberry-pi/scripts/enable-interfaces.sh`

- [ ] Create verification script
  - [ ] Create file: `setup/raspberry-pi/scripts/verify-interfaces.sh`
  - [ ] Script contents:
    - Check `/dev/i2c-1` exists
    - Check `/sys/bus/w1/devices/` exists
    - Verify `i2cdetect` installed
    - Run `i2cdetect -y 1` and verify no errors
    - Check kernel modules loaded (`lsmod | grep i2c` and `lsmod | grep w1`)
    - Output test results (pass/fail for each check)
  - [ ] Make executable: `chmod +x setup/raspberry-pi/scripts/verify-interfaces.sh`

- [ ] Create boot config snippet template
  - [ ] Create directory: `setup/raspberry-pi/config/` (if not exists)
  - [ ] Create file: `setup/raspberry-pi/config/config.txt.snippet`
  - [ ] Contents: Document required config.txt entries with comments explaining each

- [ ] Update setup guide
  - [ ] Edit `setup/raspberry-pi/SETUP-GUIDE.md`
  - [ ] Add new section: "Story 1.3: Enable I2C and 1-Wire Interfaces"
  - [ ] Document how to use `enable-interfaces.sh` script
  - [ ] Document how to use `verify-interfaces.sh` script
  - [ ] Reference `config.txt.snippet` for manual configuration

- [ ] Commit infrastructure files to git
  - [ ] Stage all new files: `git add setup/raspberry-pi/scripts/ setup/raspberry-pi/config/ setup/raspberry-pi/SETUP-GUIDE.md`
  - [ ] Commit: `git commit -m "Add I2C/1-Wire setup automation scripts (Story 1.3)"`
  - [ ] Verify commit successful

**ü§ñ PART 2: DEPLOY AND EXECUTE ON RASPBERRY PI**

- [ ] Deploy scripts to Raspberry Pi
  - [ ] Create setup directory on Pi: `ssh pi@raspberrypi.local "mkdir -p ~/setup"`
  - [ ] Copy entire setup directory: `scp -r setup/raspberry-pi/* pi@raspberrypi.local:~/setup/`
  - [ ] Verify files transferred: `ssh pi@raspberrypi.local "ls -la ~/setup/scripts/"`

- [ ] Enable I2C interface (AC: 1)
  - [ ] SSH into Raspberry Pi: `ssh pi@raspberrypi.local`
  - [ ] **[HUMAN or AI]** Run raspi-config: `sudo raspi-config` (interactive TUI - may require human if AI cannot navigate)
  - [ ] **[HUMAN or AI]** Navigate to: 3 Interface Options ‚Üí I5 I2C
  - [ ] **[HUMAN or AI]** Select "Yes" to enable I2C interface
  - [ ] **[HUMAN or AI]** Exit raspi-config (Finish ‚Üí reboot if prompted)
  - [ ] Verify I2C enabled: `ls /dev/i2c*` should show `/dev/i2c-1`

- [ ] Enable 1-Wire interface (AC: 2)
  - [ ] **[HUMAN or AI]** Run raspi-config: `sudo raspi-config`
  - [ ] **[HUMAN or AI]** Navigate to: 3 Interface Options ‚Üí I7 1-Wire
  - [ ] **[HUMAN or AI]** Select "Yes" to enable 1-Wire interface
  - [ ] **[HUMAN or AI]** Exit raspi-config (Finish ‚Üí reboot if prompted)
  - [ ] Verify 1-Wire enabled: `ls /sys/bus/w1/devices/` should exist (may be empty without sensors)

- [ ] Install I2C tools (AC: 3)
  - [ ] Update package list: `sudo apt update`
  - [ ] Install i2c-tools package: `sudo apt install i2c-tools -y`
  - [ ] Verify installation: `i2cdetect -V` (shows version number)

- [ ] Test I2C bus scanning (AC: 4)
  - [ ] Scan I2C bus 1: `i2cdetect -y 1`
  - [ ] Verify command runs without error (shows grid with "--" in all cells if no sensors connected)
  - [ ] Document expected I2C addresses for future sensor testing:
    - 0x36: STEMMA Soil Sensor (Story 1.4)
    - 0x23: BH1750 Light Sensor (Story 1.4)
    - 0x38: DHT20 Temp/Humidity Sensor (Story 1.4)

- [ ] Verify 1-Wire device tree overlay (AC: 5)
  - [ ] Check config file location (varies by Raspberry Pi OS version):
    - [ ] Try: `cat /boot/config.txt | grep w1-gpio`
    - [ ] If not found, try: `cat /boot/firmware/config.txt | grep w1-gpio`
  - [ ] Verify output contains: `dtoverlay=w1-gpio` or `dtoverlay=w1-gpio,gpiopin=4`
  - [ ] If missing, manually add to config file: `echo "dtoverlay=w1-gpio" | sudo tee -a /boot/config.txt`
  - [ ] If manual edit required, reboot Pi: `sudo reboot`
  - [ ] After reboot, verify 1-Wire modules loaded: `lsmod | grep w1`
  - [ ] Should see: `w1_gpio` and `w1_therm` modules loaded

**Alternative: Manual Config File Edit (if raspi-config unavailable or AI cannot navigate TUI):**
- [ ] Enable I2C manually: `echo "dtparam=i2c_arm=on" | sudo tee -a /boot/config.txt`
- [ ] Enable 1-Wire manually: `echo "dtoverlay=w1-gpio" | sudo tee -a /boot/config.txt`
- [ ] Reboot: `sudo reboot`

## Dev Notes

### I2C Interface Overview
**I2C (Inter-Integrated Circuit)** [Source: architecture/hardware-architecture.md]
- **Purpose:** Serial communication protocol for digital sensors
- **Raspberry Pi I2C Bus:** Bus 1 (SDA=GPIO2/Pin3, SCL=GPIO3/Pin5)
- **Sensors using I2C:** STEMMA Soil (0x36), BH1750 Light (0x23), DHT20 Temp/Humidity (0x38)
- **Advantages:** Multiple devices on 2 wires, standardized protocol, well-supported in Python

**I2C Address Map (No Conflicts):** [Source: architecture/hardware-architecture.md]
- `0x36` - STEMMA Soil Sensor
- `0x23` - BH1750 Light Sensor
- `0x38` - DHT20 Temp/Humidity Sensor

**Why Bus 1:** Raspberry Pi has two I2C buses (0 and 1). Bus 1 is standard for external devices on GPIO header.

### 1-Wire Interface Overview
**1-Wire Protocol** [Source: architecture/hardware-architecture.md]
- **Purpose:** Serial protocol for DS18B20 temperature probe
- **Raspberry Pi 1-Wire GPIO:** GPIO4 (Pin 7) by default
- **Sensor using 1-Wire:** DS18B20 Waterproof Soil Temp Probe
- **Wiring:** Requires 4.7kŒ© pullup resistor between data line and 3.3V (installed in Story 1.5)

**Device Tree Overlay:** [Source: AC 5]
- Linux kernel module `w1-gpio` enables 1-Wire communication on GPIO4
- Configuration via `/boot/config.txt` or `/boot/firmware/config.txt` (depends on Raspberry Pi OS version)
- Entry: `dtoverlay=w1-gpio` (uses default GPIO4) or `dtoverlay=w1-gpio,gpiopin=4` (explicit)

### raspi-config Tool
**Raspberry Pi Configuration Utility** [Source: epic requirements]
- **Purpose:** TUI (text user interface) for enabling hardware interfaces
- **Access:** `sudo raspi-config` via SSH
- **Relevant Options:**
  - 3 Interface Options ‚Üí I5 I2C: Enable/disable I2C interface
  - 3 Interface Options ‚Üí I7 1-Wire: Enable/disable 1-Wire interface
- **Effect:** Modifies `/boot/config.txt` and loads kernel modules (may require reboot)

### i2c-tools Package
**I2C Debugging Utilities** [Source: AC 3]
- **i2cdetect:** Scan I2C bus and display connected device addresses
- **i2cget/i2cset:** Read/write I2C device registers (low-level debugging)
- **Usage:** `i2cdetect -y 1` scans bus 1 without interactive prompts

**Expected Output (no sensors connected):**
```
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- --
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
70: -- -- -- -- -- -- -- --
```

**Expected Output (with sensors connected in Story 1.4):**
```
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- --
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
20: -- -- -- 23 -- -- -- -- -- -- -- -- -- -- -- --
30: -- -- -- -- -- -- 36 -- 38 -- -- -- -- -- -- --
...
```

### Boot Configuration Files
**Location Varies by Raspberry Pi OS Version:** [Source: AC 5]
- **Older OS:** `/boot/config.txt`
- **Newer OS (bookworm+):** `/boot/firmware/config.txt`
- **Check both locations** when verifying 1-Wire overlay

**Relevant Config Entries:**
- I2C: `dtparam=i2c_arm=on` (added by raspi-config)
- 1-Wire: `dtoverlay=w1-gpio` or `dtoverlay=w1-gpio,gpiopin=4` (added by raspi-config)

### Kernel Modules
**I2C Modules:**
- `i2c_dev` - I2C device driver interface
- `i2c_bcm2835` - Broadcom I2C hardware driver

**1-Wire Modules:**
- `w1_gpio` - 1-Wire GPIO driver
- `w1_therm` - DS18B20 temperature sensor driver

**Verification:** `lsmod | grep i2c` and `lsmod | grep w1` show loaded modules

### Dependency on Previous Stories
- **Story 1.2 (Raspberry Pi OS Setup):** SSH access required to run raspi-config and install i2c-tools
- **Next Story:** Story 1.4 will wire sensors and verify I2C/1-Wire communication

### Testing
**Testing Standards for Story 1.3:**
- **Test Type:** Manual hardware configuration verification (no automated tests)
- **Verification Steps:**
  1. ‚úÖ I2C interface enabled (verify `/dev/i2c-1` exists)
  2. ‚úÖ 1-Wire interface enabled (verify `/sys/bus/w1/devices/` exists)
  3. ‚úÖ i2c-tools installed (`i2cdetect -V` shows version)
  4. ‚úÖ I2C bus scan runs without error (`i2cdetect -y 1` shows grid)
  5. ‚úÖ 1-Wire device tree overlay loaded (`cat /boot/config.txt | grep w1-gpio` or `/boot/firmware/config.txt`)
  6. ‚úÖ Kernel modules loaded (`lsmod | grep i2c` and `lsmod | grep w1` show modules)
- **Success Criteria:** I2C and 1-Wire interfaces ready for sensor testing in Story 1.4
- **No automated tests required** - hardware configuration story
[Source: architecture/testing-strategy.md - adapted for infrastructure story]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-10-19 | 1.1 | Added infrastructure-as-code tasks: create repo scripts for repeatable Pi setup, deploy to Pi | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
**Repository Files Created:**
- `setup/raspberry-pi/scripts/enable-interfaces.sh` - Automation script for I2C/1-Wire enabling
- `setup/raspberry-pi/scripts/verify-interfaces.sh` - Verification script for interface testing
- `setup/raspberry-pi/config/config.txt.snippet` - Template showing required boot config entries
- `setup/raspberry-pi/SETUP-GUIDE.md` - Updated with Story 1.3 section

**Raspberry Pi Files Modified (not in repo):**
- `/boot/config.txt` or `/boot/firmware/config.txt` - I2C/1-Wire device tree overlays added

## QA Results
*To be filled by QA agent*
