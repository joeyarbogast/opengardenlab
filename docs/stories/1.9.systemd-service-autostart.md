# Story 1.9: Systemd Service for Autostart on Boot

## Status
Draft

## Story
**As a** developer,
**I want** the sensor sampling service to start automatically when Raspberry Pi boots,
**so that** the device operates autonomously without manual SSH login to start firmware.

## Acceptance Criteria
1. Systemd service file created: `/etc/systemd/system/opengardenlab-firmware.service`
2. Service configured to:
   - Run `python3 /home/pi/opengardenlab/firmware/sensor_service.py`
   - Restart on failure
   - Start after network.target (WiFi available)
3. Service enabled: `sudo systemctl enable opengardenlab-firmware.service`
4. Service started: `sudo systemctl start opengardenlab-firmware.service`
5. Service status verified: `sudo systemctl status opengardenlab-firmware.service` shows "active (running)"
6. Raspberry Pi rebooted, service starts automatically within 2 minutes of boot, sensor readings logged

## Tasks / Subtasks

**ü§ñ AI AGENT CAN EXECUTE (via SSH to Raspberry Pi):**

- [ ] Create systemd service file (AC: 1, 2)
  - [ ] SSH into Raspberry Pi
  - [ ] Create service file with sudo: `sudo nano /etc/systemd/system/opengardenlab-firmware.service`
  - [ ] Write service configuration:
    ```ini
    [Unit]
    Description=OpenGardenLab Sensor Sampling Service
    After=network.target
    Wants=network.target

    [Service]
    Type=simple
    User=pi
    WorkingDirectory=/home/pi/opengardenlab/firmware
    ExecStart=/usr/bin/python3 /home/pi/opengardenlab/firmware/sensor_service.py
    Restart=on-failure
    RestartSec=10
    StandardOutput=journal
    StandardError=journal

    # Environment variables (if needed)
    Environment="PYTHONUNBUFFERED=1"

    [Install]
    WantedBy=multi-user.target
    ```
  - [ ] Save and exit nano (Ctrl+X, Y, Enter)
  - [ ] Verify file created: `ls -l /etc/systemd/system/opengardenlab-firmware.service`

- [ ] Enable and start systemd service (AC: 3, 4, 5)
  - [ ] Reload systemd daemon to recognize new service:
    ```bash
    sudo systemctl daemon-reload
    ```
  - [ ] Enable service to start on boot:
    ```bash
    sudo systemctl enable opengardenlab-firmware.service
    ```
  - [ ] Verify service enabled:
    ```bash
    sudo systemctl is-enabled opengardenlab-firmware.service
    ```
  - [ ] Expected output: `enabled`
  - [ ] Start service immediately:
    ```bash
    sudo systemctl start opengardenlab-firmware.service
    ```
  - [ ] Check service status:
    ```bash
    sudo systemctl status opengardenlab-firmware.service
    ```
  - [ ] Verify status output shows:
    - [ ] `Active: active (running)` (green text)
    - [ ] Process ID displayed
    - [ ] Recent log entries from service startup
  - [ ] Document service is running successfully

- [ ] Verify service logs via journalctl (AC: 5)
  - [ ] View service logs:
    ```bash
    sudo journalctl -u opengardenlab-firmware.service -n 50
    ```
  - [ ] Verify logs show:
    - [ ] Service startup message
    - [ ] Sensor readings being captured
    - [ ] Database inserts occurring
  - [ ] Follow logs in real-time:
    ```bash
    sudo journalctl -u opengardenlab-firmware.service -f
    ```
  - [ ] Wait for one sensor reading cycle (15 minutes)
  - [ ] Verify new logs appear in journalctl
  - [ ] Stop real-time follow (Ctrl+C)

- [ ] Test service restart behavior (AC: 2)
  - [ ] Stop service manually:
    ```bash
    sudo systemctl stop opengardenlab-firmware.service
    ```
  - [ ] Verify service stopped:
    ```bash
    sudo systemctl status opengardenlab-firmware.service
    ```
  - [ ] Expected: `Active: inactive (dead)`
  - [ ] Restart service:
    ```bash
    sudo systemctl start opengardenlab-firmware.service
    ```
  - [ ] Verify service restarted successfully
  - [ ] Simulate crash: Find service process ID and kill it:
    ```bash
    sudo systemctl status opengardenlab-firmware.service | grep PID
    sudo kill -9 <PID>
    ```
  - [ ] Wait 10 seconds (RestartSec=10)
  - [ ] Check service status again:
    ```bash
    sudo systemctl status opengardenlab-firmware.service
    ```
  - [ ] Verify service auto-restarted (new PID, Active: active)
  - [ ] Document restart-on-failure behavior verified

- [ ] Test autostart on boot (AC: 6)
  - [ ] Ensure service is enabled and running
  - [ ] Reboot Raspberry Pi:
    ```bash
    sudo reboot
    ```
  - [ ] Wait 2 minutes for Pi to boot
  - [ ] SSH back into Raspberry Pi: `ssh pi@raspberrypi.local`
  - [ ] Check service status immediately after login:
    ```bash
    sudo systemctl status opengardenlab-firmware.service
    ```
  - [ ] Verify service auto-started:
    - [ ] Active: active (running)
    - [ ] Uptime matches boot time (~1-2 minutes)
  - [ ] Check logs since boot:
    ```bash
    sudo journalctl -u opengardenlab-firmware.service --since "2 minutes ago"
    ```
  - [ ] Verify sensor service started automatically:
    - [ ] Service startup log present
    - [ ] Sensor readings being captured
  - [ ] Tail log file to confirm readings stored:
    ```bash
    tail -f ~/opengardenlab/firmware/logs/sensor_service.log
    ```
  - [ ] Document autostart behavior verified

- [ ] Create service management helper scripts (optional convenience)
  - [ ] Create scripts directory: `mkdir -p ~/opengardenlab/scripts`
  - [ ] Create service control script: `nano ~/opengardenlab/scripts/service-control.sh`
  - [ ] Write helper script:
    ```bash
    #!/bin/bash
    # OpenGardenLab Service Control Helper

    SERVICE="opengardenlab-firmware.service"

    case "$1" in
      start)
        sudo systemctl start $SERVICE
        sudo systemctl status $SERVICE
        ;;
      stop)
        sudo systemctl stop $SERVICE
        sudo systemctl status $SERVICE
        ;;
      restart)
        sudo systemctl restart $SERVICE
        sudo systemctl status $SERVICE
        ;;
      status)
        sudo systemctl status $SERVICE
        ;;
      logs)
        sudo journalctl -u $SERVICE -n 50 -f
        ;;
      enable)
        sudo systemctl enable $SERVICE
        ;;
      disable)
        sudo systemctl disable $SERVICE
        ;;
      *)
        echo "Usage: $0 {start|stop|restart|status|logs|enable|disable}"
        exit 1
        ;;
    esac
    ```
  - [ ] Make script executable: `chmod +x ~/opengardenlab/scripts/service-control.sh`
  - [ ] Test helper script: `~/opengardenlab/scripts/service-control.sh status`
  - [ ] Document helper script usage

## Dev Notes

### Systemd Overview
**Purpose** [Source: architecture/tech-stack.md]
- **Service management:** Systemd is the init system and service manager for Raspberry Pi OS (Debian-based)
- **Autostart:** Ensures firmware service starts on boot without manual intervention
- **Process monitoring:** Automatically restarts service if it crashes
- **Logging integration:** Captures stdout/stderr to journald (systemd's logging system)

**Built-in to Raspberry Pi OS** [Source: architecture/tech-stack.md]
- No installation needed
- Standard on all modern Linux distributions
- Well-documented, stable, production-ready

### Systemd Service File Anatomy
**Location** [Source: AC 1]
- **Path:** `/etc/systemd/system/opengardenlab-firmware.service`
- **Requires sudo:** System-level service files need root permissions to create/edit

**Service File Structure** [Source: architecture/deployment-architecture.md]
```ini
[Unit]
Description=OpenGardenLab Sensor Sampling Service
After=network.target
Wants=network.target

[Service]
Type=simple
User=pi
WorkingDirectory=/home/pi/opengardenlab/firmware
ExecStart=/usr/bin/python3 /home/pi/opengardenlab/firmware/sensor_service.py
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal
Environment="PYTHONUNBUFFERED=1"

[Install]
WantedBy=multi-user.target
```

**Section Breakdown:**

**[Unit] - Service Metadata**
- `Description`: Human-readable name shown in systemctl output
- `After=network.target`: Wait for network to be available before starting (WiFi needed for SSH access)
- `Wants=network.target`: Prefer network but don't fail if unavailable

**[Service] - Execution Configuration**
- `Type=simple`: Service is a single foreground process (doesn't fork)
- `User=pi`: Run as `pi` user (not root) for security
- `WorkingDirectory`: Set current directory for service (important for relative paths)
- `ExecStart`: Full path to Python executable + script to run
- `Restart=on-failure`: Auto-restart if service crashes (exit code != 0)
- `RestartSec=10`: Wait 10 seconds before restarting (prevents rapid restart loops)
- `StandardOutput=journal`: Send stdout to journald
- `StandardError=journal`: Send stderr to journald
- `Environment="PYTHONUNBUFFERED=1"`: Disable Python output buffering (logs appear immediately)

**[Install] - Autostart Configuration**
- `WantedBy=multi-user.target`: Start service when system reaches multi-user mode (normal boot)

### Systemd Service Lifecycle
**Service States** [Source: AC 5]
- **active (running):** Service is currently executing
- **inactive (dead):** Service is stopped
- **failed:** Service crashed or returned non-zero exit code
- **activating:** Service is starting up
- **deactivating:** Service is shutting down

**Common Commands:**
```bash
# Start service immediately
sudo systemctl start opengardenlab-firmware.service

# Stop service
sudo systemctl stop opengardenlab-firmware.service

# Restart service (stop + start)
sudo systemctl restart opengardenlab-firmware.service

# Enable autostart on boot
sudo systemctl enable opengardenlab-firmware.service

# Disable autostart
sudo systemctl disable opengardenlab-firmware.service

# Check if enabled
sudo systemctl is-enabled opengardenlab-firmware.service

# View service status
sudo systemctl status opengardenlab-firmware.service

# Reload systemd after editing service file
sudo systemctl daemon-reload
```

### Journald Logging Integration
**What is journald?** [Source: architecture/deployment-architecture.md]
- **Systemd's logging system:** Centralized log management for all systemd services
- **Binary format:** Logs stored in binary format (not plain text like syslog)
- **Structured logging:** Logs include metadata (service name, PID, timestamp, priority)
- **Persistent by default:** Logs survive reboots (configurable)

**Viewing Logs:**
```bash
# Show last 50 lines from service
sudo journalctl -u opengardenlab-firmware.service -n 50

# Follow logs in real-time
sudo journalctl -u opengardenlab-firmware.service -f

# Show logs since last boot
sudo journalctl -u opengardenlab-firmware.service -b

# Show logs since specific time
sudo journalctl -u opengardenlab-firmware.service --since "2025-10-03 10:00:00"

# Show only errors
sudo journalctl -u opengardenlab-firmware.service -p err

# Show logs with full output (no truncation)
sudo journalctl -u opengardenlab-firmware.service --no-pager
```

**Dual Logging:**
- **File logs (Story 1.8):** `firmware/logs/sensor_service.log` - persistent, rotating file logs
- **Journald logs:** Systemd captures stdout/stderr - useful for service-level debugging
- **Both are available:** Use file logs for long-term history, journald for service status

### Auto-Restart on Failure
**Purpose** [Source: AC 2]
- **Service resilience:** If firmware crashes due to bug or sensor error, systemd automatically restarts it
- **Prevents downtime:** Device continues operating even if service crashes
- **Prevents restart loops:** `RestartSec=10` adds 10-second delay to avoid rapid crash-restart cycles

**Restart Policy:**
- `Restart=on-failure`: Restart only if service exits with non-zero code (error)
- `Restart=always`: Restart on any exit (even clean shutdown) - too aggressive for MVP
- `Restart=no`: Never restart - not suitable for autonomous device

**Testing Restart:**
1. Find service PID: `sudo systemctl status opengardenlab-firmware.service | grep PID`
2. Kill process: `sudo kill -9 <PID>`
3. Wait 10 seconds
4. Check status: Service should show new PID and "active (running)"

### Startup Order and Dependencies
**After=network.target** [Source: AC 2]
- **Why needed:** Firmware service may need WiFi for SSH access, NTP time sync
- **Doesn't block boot:** If network fails, boot continues (service may start without network)
- **Alternative:** `After=multi-user.target` (start after all basic services ready)

**Boot Timeline:**
```
0s:   Pi powers on
5s:   Kernel loads, systemd starts
10s:  Network services start (network.target)
15s:  OpenGardenLab service starts (After=network.target)
20s:  Sensor sampling begins (first reading in 15 minutes)
```

**Note:** First sensor reading won't happen until 15 minutes after service starts (sampling interval)

### Service User Permissions
**User=pi** [Source: Service file]
- **Why not root:** Running as `pi` user is safer (limited permissions, can't break system)
- **GPIO access:** `pi` user has GPIO access via `gpio` group (no root needed)
- **I2C/1-Wire access:** `pi` user has access via `i2c` group
- **File permissions:** Service writes to `/home/pi/opengardenlab/firmware/` owned by `pi`

**If running as root was needed:**
- Change `User=pi` to `User=root` (NOT recommended)
- Better: Add `pi` user to required groups, keep User=pi

### Troubleshooting Common Issues
**Service won't start:**
```bash
# Check service status for error message
sudo systemctl status opengardenlab-firmware.service

# View full logs
sudo journalctl -u opengardenlab-firmware.service -n 100

# Check if Python script has errors
python3 /home/pi/opengardenlab/firmware/sensor_service.py

# Verify file permissions
ls -l /home/pi/opengardenlab/firmware/sensor_service.py
```

**Service doesn't autostart on boot:**
```bash
# Check if service is enabled
sudo systemctl is-enabled opengardenlab-firmware.service

# Enable if disabled
sudo systemctl enable opengardenlab-firmware.service

# Check service dependencies
systemctl list-dependencies opengardenlab-firmware.service
```

**Service crashes repeatedly:**
```bash
# Check logs for crash reason
sudo journalctl -u opengardenlab-firmware.service -p err -n 50

# Increase RestartSec to 30 seconds (edit service file)
sudo nano /etc/systemd/system/opengardenlab-firmware.service
sudo systemctl daemon-reload
sudo systemctl restart opengardenlab-firmware.service
```

### Dependency on Previous Stories
- **Story 1.2 (Pi Setup):** SSH access required
- **Story 1.7 (Sensor Service):** sensor_service.py must exist and be functional
- **Story 1.8 (Logging):** Logging configured for monitoring service operation
- **Next Story:** Story 1.10 will add CI/CD pipeline for automated testing before deployment

### Expected Service Status Output
**After successful start:**
```
‚óè opengardenlab-firmware.service - OpenGardenLab Sensor Sampling Service
     Loaded: loaded (/etc/systemd/system/opengardenlab-firmware.service; enabled; vendor preset: enabled)
     Active: active (running) since Thu 2025-10-03 10:00:00 UTC; 5min ago
   Main PID: 1234 (python3)
      Tasks: 1 (limit: 392)
     Memory: 25.0M
     CGroup: /system.slice/opengardenlab-firmware.service
             ‚îî‚îÄ1234 /usr/bin/python3 /home/pi/opengardenlab/firmware/sensor_service.py

Oct 03 10:00:00 raspberrypi systemd[1]: Started OpenGardenLab Sensor Sampling Service.
Oct 03 10:00:05 raspberrypi python3[1234]: 2025-10-03 10:00:05 - INFO - Sensor service started (interval: 900s)
Oct 03 10:00:10 raspberrypi python3[1234]: 2025-10-03 10:00:10 - INFO - Sensor readings: moisture=45.2%, lux=12000, temp=22.1¬∞C
```

**Key indicators of health:**
- ‚úÖ `Active: active (running)` (green)
- ‚úÖ `enabled` in Loaded line (autostart configured)
- ‚úÖ Main PID present (process is running)
- ‚úÖ Recent log entries show sensor readings

### Testing
**Testing Standards for Story 1.9:**
- **Test Type:** System integration test (systemd + firmware service)
- **Verification Steps:**
  1. ‚úÖ Service file created in `/etc/systemd/system/`
  2. ‚úÖ Service file contains correct ExecStart path
  3. ‚úÖ Service file configured with Restart=on-failure
  4. ‚úÖ Service file configured with After=network.target
  5. ‚úÖ Service enabled (`systemctl is-enabled` returns "enabled")
  6. ‚úÖ Service started successfully (`systemctl status` shows "active (running)")
  7. ‚úÖ Logs visible via journalctl
  8. ‚úÖ Service auto-restarts after kill (test with `kill -9`)
  9. ‚úÖ Service survives reboot (autostart verified)
  10. ‚úÖ Sensor readings logged within 2 minutes of boot
  11. ‚úÖ No errors in journalctl output
- **Success Criteria:** Service starts on boot, restarts on failure, logs accessible via journalctl
- **No automated unit tests:** Manual system-level integration test
[Source: architecture/testing-strategy.md]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent*
