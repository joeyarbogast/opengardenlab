# Story 1.11: Firmware Update Procedure Documentation

## Status
Draft

## Story
**As a** developer,
**I want** a documented procedure for updating firmware on deployed Raspberry Pi devices,
**so that** I can fix bugs and add features to devices already in the field without re-flashing SD cards.

## Acceptance Criteria
1. Firmware update guide created: `docs/firmware-update-guide.md`
2. SSH-based update procedure documented:
   - SSH into Raspberry Pi (`ssh pi@raspberrypi.local`)
   - Stop systemd service (`sudo systemctl stop opengardenlab-firmware.service`)
   - Pull latest firmware from Git (`cd ~/opengardenlab && git pull origin main`)
   - Install updated dependencies (`pip3 install -r firmware/requirements.txt`)
   - Restart systemd service (`sudo systemctl start opengardenlab-firmware.service`)
   - Verify service running (`sudo systemctl status opengardenlab-firmware.service`)
3. Backup procedure documented (export SQLite database before update)
4. Rollback procedure documented (git checkout to previous commit if update fails)
5. Version tracking added to firmware:
   - Firmware version number in `firmware/version.txt` or `config.yaml`
   - Version logged on startup (visible in `firmware/logs/sensor_service.log`)
6. Update procedure tested: successfully update firmware on test device without data loss

## Tasks / Subtasks

**ðŸ¤– AI AGENT CAN EXECUTE (via SSH or local repository):**

- [ ] Create firmware version file (AC: 5)
  - [ ] Navigate to repository root
  - [ ] Create version file: `nano firmware/version.txt`
  - [ ] Write initial version:
    ```
    1.0.0
    ```
  - [ ] Save and commit version file
  - [ ] Alternative: Add version to config.yaml:
    ```yaml
    firmware_version: "1.0.0"
    device_id: "opengardenlab-rpi001"
    ...
    ```

- [ ] Update sensor_service.py to log version on startup (AC: 5)
  - [ ] Edit sensor service: `nano firmware/sensor_service.py`
  - [ ] Add version loading in `__init__()`:
    ```python
    # Load firmware version
    version_file = os.path.join(os.path.dirname(__file__), 'version.txt')
    try:
        with open(version_file, 'r') as f:
            self.version = f.read().strip()
    except FileNotFoundError:
        self.version = "unknown"
    ```
  - [ ] Update startup log in `run()` method:
    ```python
    self.logger.info(f"OpenGardenLab Firmware v{self.version}")
    self.logger.info(f"Sensor service started (interval: {self.sampling_interval}s)")
    ```
  - [ ] Save changes

- [ ] Create firmware update guide (AC: 1, 2, 3, 4)
  - [ ] Create docs file: `nano docs/firmware-update-guide.md`
  - [ ] Write comprehensive update guide:

```markdown
# Firmware Update Guide

This guide explains how to update firmware on deployed Raspberry Pi devices without re-flashing SD cards.

## Prerequisites

- SSH access to Raspberry Pi (`ssh pi@raspberrypi.local`)
- Git repository cloned at `/home/pi/opengardenlab/`
- Systemd service installed and running (Story 1.9)

## Pre-Update Checklist

1. **Check current firmware version:**
   ```bash
   ssh pi@raspberrypi.local
   tail -n 50 ~/opengardenlab/firmware/logs/sensor_service.log | grep "Firmware v"
   ```

2. **Verify service is running:**
   ```bash
   sudo systemctl status opengardenlab-firmware.service
   ```

3. **Check for uncommitted local changes:**
   ```bash
   cd ~/opengardenlab
   git status
   ```
   - If local changes exist, back them up or commit them before proceeding

## Backup Procedure (RECOMMENDED)

**Always backup database before updating:**

```bash
# Create backup directory
mkdir -p ~/opengardenlab-backups

# Backup SQLite database with timestamp
BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
cp ~/opengardenlab/firmware/data/sensor_data.db \
   ~/opengardenlab-backups/sensor_data_${BACKUP_DATE}.db

# Backup configuration file
cp ~/opengardenlab/firmware/config.yaml \
   ~/opengardenlab-backups/config_${BACKUP_DATE}.yaml

# Verify backup created
ls -lh ~/opengardenlab-backups/
```

**Backup retention:**
- Keep last 5 backups
- Delete older backups: `rm ~/opengardenlab-backups/sensor_data_YYYYMMDD_*.db`

## Standard Update Procedure

**Step 1: SSH into Raspberry Pi**
```bash
ssh pi@raspberrypi.local
```

**Step 2: Stop firmware service**
```bash
sudo systemctl stop opengardenlab-firmware.service
```

**Step 3: Verify service stopped**
```bash
sudo systemctl status opengardenlab-firmware.service
# Expected: "Active: inactive (dead)"
```

**Step 4: Pull latest firmware from GitHub**
```bash
cd ~/opengardenlab
git pull origin main
```

**Expected output:**
```
Updating abc1234..def5678
Fast-forward
 firmware/sensor_service.py | 10 +++++++++-
 firmware/version.txt       |  2 +-
 2 files changed, 10 insertions(+), 2 deletions(-)
```

**Step 5: Install updated Python dependencies**
```bash
pip3 install -r firmware/requirements.txt --upgrade
```

**Step 6: Check for database schema migrations**
```bash
# Check if schema changes are documented in release notes
cat docs/release-notes.md

# If schema migration required, run migration script (future enhancement)
# python3 firmware/migrations/migrate_vX_to_vY.py
```

**Step 7: Restart firmware service**
```bash
sudo systemctl start opengardenlab-firmware.service
```

**Step 8: Verify service started successfully**
```bash
sudo systemctl status opengardenlab-firmware.service
# Expected: "Active: active (running)"
```

**Step 9: Monitor logs for startup errors**
```bash
tail -f ~/opengardenlab/firmware/logs/sensor_service.log
```

**Expected output:**
```
2025-10-03 10:00:00 - INFO - OpenGardenLab Firmware v1.1.0
2025-10-03 10:00:00 - INFO - Sensor service started (interval: 900s)
2025-10-03 10:00:05 - INFO - Sensor readings: moisture=45.2%, ...
```

**Step 10: Verify sensor readings continue**
- Wait 1-2 sampling cycles (15-30 minutes)
- Check logs for successful sensor readings
- Query database to verify new readings stored:
  ```bash
  sqlite3 ~/opengardenlab/firmware/data/sensor_data.db \
    "SELECT * FROM sensor_readings ORDER BY timestamp DESC LIMIT 5"
  ```

## Rollback Procedure

**If update causes issues, rollback to previous version:**

**Step 1: Stop service**
```bash
sudo systemctl stop opengardenlab-firmware.service
```

**Step 2: Check Git commit history**
```bash
cd ~/opengardenlab
git log --oneline -5
```

**Expected output:**
```
def5678 (HEAD -> main) Add new feature X
abc1234 Fix bug in sensor reading
789abcd Update logging format
```

**Step 3: Rollback to previous commit**
```bash
# Rollback to commit before current one
git checkout abc1234

# Or rollback by number of commits (1 commit back)
git checkout HEAD~1
```

**Step 4: Reinstall dependencies (in case they changed)**
```bash
pip3 install -r firmware/requirements.txt
```

**Step 5: Restart service**
```bash
sudo systemctl start opengardenlab-firmware.service
```

**Step 6: Verify rollback successful**
```bash
tail -f ~/opengardenlab/firmware/logs/sensor_service.log
# Check version number matches previous version
```

**Step 7: Restore database backup if needed**
```bash
# Only if new version corrupted database
sudo systemctl stop opengardenlab-firmware.service

# Find latest backup
ls -lt ~/opengardenlab-backups/sensor_data_*.db | head -1

# Restore backup (REPLACE YYYYMMDD_HHMMSS with actual timestamp)
cp ~/opengardenlab-backups/sensor_data_YYYYMMDD_HHMMSS.db \
   ~/opengardenlab/firmware/data/sensor_data.db

sudo systemctl start opengardenlab-firmware.service
```

## Troubleshooting

### Issue: `git pull` fails with "uncommitted changes"

**Cause:** Local modifications to firmware files

**Solution:**
```bash
# Stash local changes
git stash

# Pull updates
git pull origin main

# Re-apply local changes (may have conflicts)
git stash pop
```

### Issue: Service fails to start after update

**Symptoms:**
```bash
sudo systemctl status opengardenlab-firmware.service
# Shows "failed" or "inactive (dead)"
```

**Diagnosis:**
```bash
# Check service logs for errors
sudo journalctl -u opengardenlab-firmware.service -n 50

# Check Python errors
python3 ~/opengardenlab/firmware/sensor_service.py
```

**Common causes:**
1. **Missing dependencies:** Run `pip3 install -r firmware/requirements.txt`
2. **Syntax error:** Check journalctl logs for Python traceback
3. **Config file missing:** Verify `config.yaml` exists and is valid YAML

**Solution:** Rollback to previous version (see Rollback Procedure)

### Issue: Database schema incompatible after update

**Symptoms:** SQLite errors in logs like "no such column: new_field"

**Solution:**
```bash
# Restore database from backup
sudo systemctl stop opengardenlab-firmware.service

cp ~/opengardenlab-backups/sensor_data_YYYYMMDD_HHMMSS.db \
   ~/opengardenlab/firmware/data/sensor_data.db

# Rollback firmware
cd ~/opengardenlab
git checkout HEAD~1

sudo systemctl start opengardenlab-firmware.service
```

## Automated Update Script (Optional)

**Create update script for convenience:**

```bash
nano ~/opengardenlab/scripts/update-firmware.sh
```

**Script contents:**
```bash
#!/bin/bash
# OpenGardenLab Firmware Update Script

set -e  # Exit on error

echo "=== OpenGardenLab Firmware Update ==="
echo ""

# Backup database
echo "1. Backing up database..."
BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p ~/opengardenlab-backups
cp ~/opengardenlab/firmware/data/sensor_data.db \
   ~/opengardenlab-backups/sensor_data_${BACKUP_DATE}.db
echo "   Backup created: sensor_data_${BACKUP_DATE}.db"

# Stop service
echo ""
echo "2. Stopping firmware service..."
sudo systemctl stop opengardenlab-firmware.service

# Pull updates
echo ""
echo "3. Pulling latest firmware..."
cd ~/opengardenlab
git pull origin main

# Update dependencies
echo ""
echo "4. Updating dependencies..."
pip3 install -r firmware/requirements.txt --upgrade --quiet

# Restart service
echo ""
echo "5. Restarting firmware service..."
sudo systemctl start opengardenlab-firmware.service

# Verify status
echo ""
echo "6. Verifying service status..."
sleep 2
sudo systemctl status opengardenlab-firmware.service --no-pager

echo ""
echo "=== Update Complete ==="
echo ""
echo "Monitor logs: tail -f ~/opengardenlab/firmware/logs/sensor_service.log"
```

**Make script executable:**
```bash
chmod +x ~/opengardenlab/scripts/update-firmware.sh
```

**Run update:**
```bash
~/opengardenlab/scripts/update-firmware.sh
```

## Version Tracking

**Check current firmware version:**
```bash
# From log file
tail ~/opengardenlab/firmware/logs/sensor_service.log | grep "Firmware v"

# From version file
cat ~/opengardenlab/firmware/version.txt

# From config file (if using config.yaml)
grep firmware_version ~/opengardenlab/firmware/config.yaml
```

**Update version number:**
```bash
# Edit version file
nano ~/opengardenlab/firmware/version.txt

# Or edit config
nano ~/opengardenlab/firmware/config.yaml
```

**Versioning scheme:**
- `1.0.0` - Major.Minor.Patch
- **Major:** Breaking changes (database schema, API protocol)
- **Minor:** New features (backward compatible)
- **Patch:** Bug fixes (no new features)

## Post-MVP Enhancements

**Future improvements (not in MVP):**

1. **Over-the-Air (OTA) Updates via Bluetooth**
   - Mobile app sends firmware file to Raspberry Pi
   - Pi automatically extracts, backs up, and updates
   - No SSH required

2. **Automatic Rollback on Crash**
   - If firmware crashes within 5 minutes of update, auto-rollback
   - Systemd watchdog integration

3. **Database Schema Migrations**
   - Alembic for Python (similar to Django migrations)
   - Automatic schema version detection
   - Incremental migration scripts

4. **Firmware Update Notifications**
   - Pi checks GitHub for new releases
   - Notifies user via mobile app: "Update available: v1.2.0"
   - User triggers update from mobile app

## Resources

- [Git Documentation](https://git-scm.com/doc)
- [Systemd Service Management](https://www.freedesktop.org/software/systemd/man/systemctl.html)
- [SQLite Backup](https://www.sqlite.org/backup.html)
```

  - [ ] Save firmware update guide

- [ ] Test firmware update procedure (AC: 6)
  - [ ] SSH into Raspberry Pi
  - [ ] Make a trivial change to firmware (e.g., update version to 1.0.1)
  - [ ] Commit and push change to GitHub repo
  - [ ] On Raspberry Pi, create database backup:
    ```bash
    cp ~/opengardenlab/firmware/data/sensor_data.db \
       ~/opengardenlab/firmware/data/sensor_data_backup.db
    ```
  - [ ] Follow documented update procedure:
    - [ ] Stop service: `sudo systemctl stop opengardenlab-firmware.service`
    - [ ] Pull updates: `cd ~/opengardenlab && git pull origin main`
    - [ ] Update deps: `pip3 install -r firmware/requirements.txt`
    - [ ] Restart service: `sudo systemctl start opengardenlab-firmware.service`
  - [ ] Verify service restarted successfully
  - [ ] Check logs show new version number
  - [ ] Verify database still has readings (no data loss):
    ```bash
    sqlite3 ~/opengardenlab/firmware/data/sensor_data.db \
      "SELECT COUNT(*) FROM sensor_readings"
    ```
  - [ ] Test rollback procedure:
    - [ ] Stop service
    - [ ] `git checkout HEAD~1` (rollback to previous commit)
    - [ ] Restart service
    - [ ] Verify old version number in logs
  - [ ] Document update procedure verified

- [ ] Add update guide link to main README (AC: 1)
  - [ ] Edit README: `nano README.md`
  - [ ] Add link to firmware update guide in documentation section:
    ```markdown
    ## Documentation

    - [Product Requirements Document (PRD)](docs/prd.md)
    - [Architecture Documentation](docs/architecture.md)
    - [Firmware Update Guide](docs/firmware-update-guide.md)
    ```
  - [ ] Save and commit changes

## Dev Notes

### Firmware Update Strategy
**SSH-Based Updates (MVP)** [Source: AC 2]
- **Manual process:** Developer SSHs into Pi, runs git pull
- **No OTA capability:** Requires network access to Pi
- **Simple, reliable:** Uses standard Git workflow
- **Suitable for MVP:** Small number of devices (1-3 during development)

**Post-MVP OTA Updates:** [Source: AC 6 notes]
- Bluetooth-based firmware transfer from mobile app
- Automatic backup, update, and restart
- User-friendly (no SSH knowledge needed)

### Version Tracking
**Why Version Tracking?** [Source: AC 5]
- **Troubleshooting:** Know which firmware version is running on device
- **Update verification:** Confirm update was successful
- **Rollback validation:** Verify rollback to correct version
- **Bug reports:** Users can report "Issue on v1.2.3"

**Version File Options:**

**Option 1: Standalone version.txt** [Source: AC 5]
```
1.0.0
```
**Pros:** Simple, easy to parse, single source of truth
**Cons:** Extra file to maintain

**Option 2: Version in config.yaml** [Source: AC 5]
```yaml
firmware_version: "1.0.0"
device_id: "opengardenlab-rpi001"
sampling_interval_minutes: 15
```
**Pros:** Version with other config, one less file
**Cons:** Config file might be user-edited (version could be wrong)

**Recommendation:** Use `version.txt` for simplicity (MVP approach)

### Semantic Versioning
**Format:** `MAJOR.MINOR.PATCH` [Source: docs/firmware-update-guide.md]

**Version Components:**
- **MAJOR:** Breaking changes (database schema, Bluetooth protocol, config format)
- **MINOR:** New features (backward compatible, no breaking changes)
- **PATCH:** Bug fixes (no new features, no breaking changes)

**Examples:**
- `1.0.0` - Initial MVP release (Story 1.11 completion)
- `1.1.0` - Add LED health indicator (new feature, backward compatible)
- `1.0.1` - Fix sensor calibration bug (patch, no new features)
- `2.0.0` - Change database schema (breaking change, requires migration)

### Backup Strategy
**Why Backup Database?** [Source: AC 3]
- **Data safety:** Firmware bugs could corrupt database
- **Rollback support:** Restore previous data if update fails
- **Peace of mind:** Can always revert to known-good state

**Backup Procedure:**
```bash
# Create backup directory (one-time)
mkdir -p ~/opengardenlab-backups

# Backup database with timestamp
BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
cp ~/opengardenlab/firmware/data/sensor_data.db \
   ~/opengardenlab-backups/sensor_data_${BACKUP_DATE}.db
```

**Backup Retention:**
- Keep last 5-10 backups (enough for recent history)
- Backups are small (~1-10MB depending on data volume)
- Manually delete old backups: `rm ~/opengardenlab-backups/sensor_data_202410*.db`

**Automatic Backups (Future):**
- Cron job to backup database daily
- Systemd timer to backup before updates
- Mobile app exports database via Bluetooth

### Rollback Strategy
**Why Rollback?** [Source: AC 4]
- **Update failures:** New firmware crashes or has critical bugs
- **Database incompatibility:** Schema changes break existing data
- **Quick recovery:** Restore to known-good state in minutes

**Git Rollback:**
```bash
# View commit history
git log --oneline -5

# Rollback to specific commit
git checkout <commit-hash>

# Rollback 1 commit back
git checkout HEAD~1

# Return to latest version
git checkout main
git pull
```

**Database Rollback:**
```bash
# Restore from backup
cp ~/opengardenlab-backups/sensor_data_YYYYMMDD_HHMMSS.db \
   ~/opengardenlab/firmware/data/sensor_data.db
```

### Update Procedure Steps
**Standard Update Flow:** [Source: AC 2]
1. **Stop service** - Prevent database writes during update
2. **Pull updates** - Download latest firmware from Git
3. **Update dependencies** - Install new Python libraries if needed
4. **Restart service** - Start new firmware version
5. **Verify operation** - Check logs, monitor sensor readings

**Why stop service first?**
- Prevents database corruption (service writing while files change)
- Ensures clean shutdown (no partial sensor reads)
- Avoids file conflicts (service holding file locks)

**Why update dependencies?**
- New firmware may require new Python libraries
- Library versions may have security patches
- `pip3 install --upgrade` ensures latest compatible versions

### Database Schema Migrations
**MVP Approach (Story 1.11):** [Source: AC 2]
- **No automatic migrations:** Schema changes are manual
- **Breaking changes documented:** Release notes explain schema changes
- **Manual migration scripts:** Developer writes SQL to update schema

**Post-MVP Approach:**
- **Alembic (Python):** Database migration framework (like Django migrations)
- **Automatic version detection:** Compare installed schema to required schema
- **Incremental migrations:** Run only missing migration steps
- **Rollback support:** Downgrade schema if firmware rollback needed

**Example Migration Script (Future):**
```python
# firmware/migrations/001_add_battery_voltage.py
import sqlite3

def upgrade(db_path):
    conn = sqlite3.connect(db_path)
    conn.execute("ALTER TABLE sensor_readings ADD COLUMN battery_voltage REAL")
    conn.commit()
    print("Migration 001 applied: Added battery_voltage column")

def downgrade(db_path):
    # SQLite doesn't support DROP COLUMN, requires table rebuild
    print("Downgrade not supported for this migration")
```

### Automated Update Script
**Purpose:** [Source: docs/firmware-update-guide.md]
- **Convenience:** One command to update firmware
- **Error handling:** Script exits on first error (`set -e`)
- **Consistent procedure:** Reduces human error

**Script Location:** `scripts/update-firmware.sh`

**Script Features:**
1. Automatic database backup with timestamp
2. Service stop/start with error checking
3. Git pull with status output
4. Dependency update
5. Service status verification

**Usage:**
```bash
~/opengardenlab/scripts/update-firmware.sh
```

**Future Enhancements:**
- Pre-flight checks (disk space, network connectivity)
- Automatic rollback on failure
- Email/Slack notifications on update completion

### Dependency on Previous Stories
- **Story 1.6 (Storage):** Database backup critical for update safety
- **Story 1.7 (Sensor Service):** Service to update and restart
- **Story 1.9 (Systemd):** Service management for updates
- **Story 1.10 (CI/CD):** CI tests ensure update quality before deployment

### Testing
**Testing Standards for Story 1.11:**
- **Test Type:** End-to-end update procedure test on real Raspberry Pi
- **Verification Steps:**
  1. âœ… Version file created (`firmware/version.txt` or in `config.yaml`)
  2. âœ… sensor_service.py logs version on startup
  3. âœ… Firmware update guide created (`docs/firmware-update-guide.md`)
  4. âœ… Update guide includes all required procedures (backup, update, rollback)
  5. âœ… Database backup procedure documented and tested
  6. âœ… Standard update procedure documented and tested
  7. âœ… Rollback procedure documented and tested
  8. âœ… Troubleshooting section includes common issues
  9. âœ… Automated update script created (optional but recommended)
  10. âœ… Test update on Raspberry Pi:
      - [ ] Backup database successfully
      - [ ] Pull updates from Git successfully
      - [ ] Service restarts with new version
      - [ ] No data loss (readings preserved)
  11. âœ… Test rollback on Raspberry Pi:
      - [ ] Checkout previous commit
      - [ ] Service restarts with old version
      - [ ] No data loss
  12. âœ… Update guide linked from main README
- **Success Criteria:** Complete update and rollback procedures documented, tested successfully without data loss
- **No automated tests:** Manual end-to-end test (update/rollback procedures are inherently manual)
[Source: architecture/testing-strategy.md]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent*
