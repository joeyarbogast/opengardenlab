# Story 1.4: Sensor Library Installation and I2C Sensor Test

## Status
Draft

## Story
**As a** developer,
**I want** Adafruit CircuitPython libraries installed and I2C sensors (STEMMA Soil, BH1750, DHT20) reading successfully,
**so that** I can validate hardware wiring and sensor functionality before building the full sampling service.

## Acceptance Criteria
1. Python libraries installed via pip3:
   - `adafruit-circuitpython-seesaw` (STEMMA Soil)
   - `adafruit-circuitpython-bh1750` (BH1750 light sensor)
   - `adafruit-circuitpython-ahtx0` (DHT20/AHT20 temp/humidity)
2. All I2C sensors wired to Pi (VCC, GND, SDA/Pin3, SCL/Pin5) - breadboard or STEMMA cables
3. `i2cdetect -y 1` shows sensor addresses: 0x36 (STEMMA Soil), 0x23 (BH1750), 0x38 (DHT20)
4. Simple Python test script reads and prints values from all 3 I2C sensors:
   - STEMMA Soil: moisture raw value + soil temp (¬∞C)
   - BH1750: lux value
   - DHT20: air temp (¬∞C) + humidity (%)
5. Test script runs without errors, values are sensible (e.g., indoor lux ~100-500, temp ~20¬∞C)

## Tasks / Subtasks

**‚ö†Ô∏è MIXED: Hardware wiring requires human, software installation can be done via SSH**

**ü§ñ AI AGENT CAN EXECUTE (via SSH to Raspberry Pi):**

- [ ] Install Adafruit CircuitPython libraries (AC: 1)
  - [ ] SSH into Raspberry Pi
  - [ ] Update pip3: `pip3 install --upgrade pip`
  - [ ] Install Adafruit Blinka (CircuitPython compatibility layer): `pip3 install adafruit-blinka`
  - [ ] Install STEMMA Soil library: `pip3 install adafruit-circuitpython-seesaw`
  - [ ] Install BH1750 light sensor library: `pip3 install adafruit-circuitpython-bh1750`
  - [ ] Install DHT20/AHT20 library: `pip3 install adafruit-circuitpython-ahtx0`
  - [ ] Verify installations: `pip3 list | grep adafruit`

**‚ö†Ô∏è HARDWARE SETUP - HUMAN REQUIRED:**

- [ ] **[HUMAN]** Wire I2C sensors to Raspberry Pi GPIO (AC: 2)
  - [ ] **[HUMAN]** Power off Raspberry Pi: `sudo shutdown -h now`
  - [ ] **[HUMAN]** Wire STEMMA Soil Sensor:
    - [ ] Red wire ‚Üí Pin 1 (3.3V)
    - [ ] Black wire ‚Üí Pin 6 (GND)
    - [ ] White/SDA wire ‚Üí Pin 3 (GPIO2/SDA)
    - [ ] Yellow/SCL wire ‚Üí Pin 5 (GPIO3/SCL)
  - [ ] **[HUMAN]** Wire BH1750 Light Sensor:
    - [ ] VCC ‚Üí Pin 1 (3.3V) - share with STEMMA
    - [ ] GND ‚Üí Pin 6 (GND) - share with STEMMA
    - [ ] SDA ‚Üí Pin 3 (GPIO2/SDA) - I2C bus shared
    - [ ] SCL ‚Üí Pin 5 (GPIO3/SCL) - I2C bus shared
  - [ ] **[HUMAN]** Wire DHT20 Temp/Humidity Sensor:
    - [ ] VCC ‚Üí Pin 1 (3.3V) - share power rail
    - [ ] GND ‚Üí Pin 6 (GND) - share ground rail
    - [ ] SDA ‚Üí Pin 3 (GPIO2/SDA) - I2C bus shared
    - [ ] SCL ‚Üí Pin 5 (GPIO3/SCL) - I2C bus shared
  - [ ] **[HUMAN]** Double-check all connections before powering on
  - [ ] **[HUMAN]** Power on Raspberry Pi

**ü§ñ AI AGENT CAN EXECUTE (via SSH to Raspberry Pi):**

- [ ] Verify I2C sensor detection (AC: 3)
  - [ ] SSH into Raspberry Pi after boot
  - [ ] Scan I2C bus: `i2cdetect -y 1`
  - [ ] Verify sensor addresses appear:
    - [ ] 0x36 (STEMMA Soil Sensor)
    - [ ] 0x23 (BH1750 Light Sensor)
    - [ ] 0x38 (DHT20 Temp/Humidity Sensor)
  - [ ] If any sensor missing, check wiring and re-scan
  - [ ] Document I2C scan output for reference

- [ ] Create test script for I2C sensors (AC: 4, 5)
  - [ ] Create test script directory: `mkdir -p ~/opengardenlab/firmware/tests`
  - [ ] Create test file: `nano ~/opengardenlab/firmware/tests/test_i2c_sensors.py`
  - [ ] Write test script code:
    ```python
    #!/usr/bin/env python3
    import time
    import board
    from adafruit_seesaw.seesaw import Seesaw
    from adafruit_bh1750 import BH1750
    from adafruit_ahtx0 import AHTx0

    # Initialize I2C bus
    i2c = board.I2C()

    # Initialize sensors
    print("Initializing sensors...")
    stemma = Seesaw(i2c, addr=0x36)
    bh1750 = BH1750(i2c)
    dht20 = AHTx0(i2c)

    print("Reading sensors...\n")

    # Read STEMMA Soil Sensor
    moisture_raw = stemma.moisture_read()
    soil_temp_c = stemma.get_temp()
    print(f"STEMMA Soil Sensor:")
    print(f"  Moisture (raw): {moisture_raw}")
    print(f"  Soil Temp: {soil_temp_c:.1f}¬∞C\n")

    # Read BH1750 Light Sensor
    lux = bh1750.lux
    print(f"BH1750 Light Sensor:")
    print(f"  Light: {lux:.1f} lux\n")

    # Read DHT20 Air Temp/Humidity
    air_temp_c = dht20.temperature
    humidity = dht20.relative_humidity
    print(f"DHT20 Air Temp/Humidity:")
    print(f"  Air Temp: {air_temp_c:.1f}¬∞C")
    print(f"  Humidity: {humidity:.1f}%\n")

    print("Test complete!")
    ```
  - [ ] Save and exit nano (Ctrl+X, Y, Enter)
  - [ ] Make script executable: `chmod +x ~/opengardenlab/firmware/tests/test_i2c_sensors.py`

- [ ] Run test script and validate readings (AC: 5)
  - [ ] Execute test script: `python3 ~/opengardenlab/firmware/tests/test_i2c_sensors.py`
  - [ ] Verify script runs without errors (no exceptions or tracebacks)
  - [ ] Validate sensor readings are sensible:
    - [ ] STEMMA moisture raw: 200-2000 (depends on air vs water, uncalibrated)
    - [ ] STEMMA soil temp: ~18-25¬∞C (indoor room temperature)
    - [ ] BH1750 lux: 100-500 (typical indoor lighting) or 10,000-65,000 (direct sunlight)
    - [ ] DHT20 air temp: ~18-25¬∞C (room temperature)
    - [ ] DHT20 humidity: 30-70% (typical indoor humidity)
  - [ ] If readings are nonsensical (e.g., -40¬∞C, 0 lux indoors), troubleshoot wiring or library installation
  - [ ] Document successful test output for story completion

## Dev Notes

### Adafruit CircuitPython Libraries
**CircuitPython Ecosystem** [Source: architecture/tech-stack.md]
- **Adafruit Blinka:** Compatibility layer that brings CircuitPython APIs to Raspberry Pi (Linux)
- **Purpose:** Provides consistent API for sensor libraries across microcontrollers and single-board computers
- **Advantage:** Well-documented, beginner-friendly, official Adafruit support

**Required Libraries:** [Source: AC 1, architecture/tech-stack.md]
1. **adafruit-circuitpython-seesaw** - STEMMA Soil Sensor driver (I2C capacitive moisture + soil temp)
2. **adafruit-circuitpython-bh1750** - BH1750 light sensor driver (1-65,535 lux range)
3. **adafruit-circuitpython-ahtx0** - DHT20/AHT20 temp/humidity driver

**Installation:** All libraries installed via pip3 (Python package manager)

### I2C Sensor Wiring
**Shared I2C Bus Architecture** [Source: architecture/hardware-architecture.md]
- **Advantage:** All I2C sensors share 2 wires (SDA, SCL) - simplifies wiring, scalable
- **Raspberry Pi I2C Pins:**
  - Pin 1 (3.3V) - Power for all sensors
  - Pin 3 (GPIO2/SDA) - I2C data line (shared by all I2C devices)
  - Pin 5 (GPIO3/SCL) - I2C clock line (shared by all I2C devices)
  - Pin 6 (GND) - Ground for all sensors

**Sensor I2C Addresses (No Conflicts):** [Source: architecture/hardware-architecture.md]
- 0x36 - STEMMA Soil Sensor
- 0x23 - BH1750 Light Sensor
- 0x38 - DHT20 Temp/Humidity Sensor

**Wiring Best Practices:**
- Use STEMMA QT cables (plug-and-play) if sensors have QT connectors
- Alternatively, use breadboard with jumper wires
- Keep I2C wire length under 1 meter to avoid signal degradation
- Connect all sensors before powering on Raspberry Pi (prevent hot-plugging issues)

### Expected I2C Detection Output
**i2cdetect -y 1 (all sensors connected):** [Source: AC 3]
```
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- --
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
20: -- -- -- 23 -- -- -- -- -- -- -- -- -- -- -- --
30: -- -- -- -- -- -- 36 -- 38 -- -- -- -- -- -- --
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
70: -- -- -- -- -- -- -- --
```
- `23` = BH1750 Light Sensor
- `36` = STEMMA Soil Sensor
- `38` = DHT20 Temp/Humidity Sensor

**Troubleshooting Missing Addresses:**
- Check power connections (3.3V and GND)
- Verify SDA/SCL wiring (Pin 3 and Pin 5)
- Ensure I2C interface enabled (Story 1.3)
- Reboot Raspberry Pi and re-scan

### Test Script Details
**Purpose:** Validate sensor hardware and library installation before building full firmware service

**Test Script Structure:** [Source: AC 4]
1. Import Adafruit libraries and board module
2. Initialize I2C bus (`board.I2C()`)
3. Create sensor objects with I2C addresses
4. Read sensor values
5. Print formatted output

**Expected Output Example:**
```
Initializing sensors...
Reading sensors...

STEMMA Soil Sensor:
  Moisture (raw): 512
  Soil Temp: 22.3¬∞C

BH1750 Light Sensor:
  Light: 348.2 lux

DHT20 Air Temp/Humidity:
  Air Temp: 23.1¬∞C
  Humidity: 45.6%

Test complete!
```

**Sensible Value Ranges:** [Source: AC 5]
- **Moisture raw:** 200-2000 (uncalibrated - air vs water, calibration in Story 1.7)
- **Soil temp:** 15-30¬∞C (indoor testing, will vary outdoors)
- **Lux:** 100-500 (indoor ambient), 1000-10000 (bright room), 10000-65000 (direct sunlight)
- **Air temp:** 15-30¬∞C (room temperature)
- **Humidity:** 20-80% (indoor range)

### Dependency on Previous Stories
- **Story 1.2 (Pi Setup):** SSH access and Python 3.9+ required
- **Story 1.3 (I2C Enable):** I2C interface must be enabled, i2c-tools installed
- **Next Story:** Story 1.5 will add DS18B20 1-Wire temperature probe

### Testing
**Testing Standards for Story 1.4:**
- **Test Type:** Manual hardware integration test (executable test script validates sensor communication)
- **Verification Steps:**
  1. ‚úÖ Adafruit libraries installed (`pip3 list | grep adafruit`)
  2. ‚úÖ All I2C sensors wired to correct GPIO pins
  3. ‚úÖ i2cdetect shows all three sensor addresses (0x23, 0x36, 0x38)
  4. ‚úÖ Test script (`test_i2c_sensors.py`) created in `firmware/tests/`
  5. ‚úÖ Test script runs without errors (no Python exceptions)
  6. ‚úÖ Sensor readings are sensible (within expected ranges documented above)
- **Success Criteria:** All three I2C sensors communicate successfully via Python libraries
- **Test Script Location:** `~/opengardenlab/firmware/tests/test_i2c_sensors.py`
- **No pytest unit tests required** - hardware validation story using executable test script
[Source: architecture/testing-strategy.md - adapted for hardware integration story]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent*
