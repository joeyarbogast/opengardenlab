# Story 1.5: 1-Wire Sensor Integration (DS18B20 Soil Temp Probe)

## Status
Draft

## Story
**As a** developer,
**I want** the DS18B20 waterproof temperature probe reading soil temperature via 1-Wire,
**so that** I have a more accurate soil temperature sensor than the STEMMA Soil's built-in sensor.

## Acceptance Criteria
1. DS18B20 probe wired: Red→3.3V, Black→GND, Yellow→GPIO4 (Pin7), 4.7kΩ pullup resistor between Yellow and Red
2. 1-Wire kernel modules loaded (automatic after enabling 1-Wire in story 1.3)
3. `w1thermsensor` Python library installed (`pip3 install w1thermsensor`)
4. Python test script reads DS18B20 temperature successfully (prints temp in °C and °F)
5. DS18B20 reading matches room temperature ±1°C (validation test)

## Tasks / Subtasks

**⚠️ MIXED: Hardware wiring requires human, software installation can be done via SSH**

**⚠️ HARDWARE SETUP - HUMAN REQUIRED:**

- [ ] **[HUMAN]** Wire DS18B20 temperature probe to Raspberry Pi GPIO (AC: 1)
  - [ ] **[HUMAN]** Power off Raspberry Pi: `sudo shutdown -h now`
  - [ ] **[HUMAN]** Wire DS18B20 Waterproof Probe:
    - [ ] Red wire → Pin 1 (3.3V) - share with existing I2C sensors
    - [ ] Black wire → Pin 6 (GND) - share with existing I2C sensors
    - [ ] Yellow/Data wire → Pin 7 (GPIO4/1-Wire)
  - [ ] **[HUMAN]** Install 4.7kΩ pullup resistor:
    - [ ] Connect resistor between Yellow wire (GPIO4/Pin7) and Red wire (3.3V/Pin1)
    - [ ] This pullup resistor is REQUIRED for 1-Wire bus to function properly
  - [ ] **[HUMAN]** Double-check all connections before powering on
  - [ ] **[HUMAN]** Power on Raspberry Pi

**🤖 AI AGENT CAN EXECUTE (via SSH to Raspberry Pi):**

- [ ] Verify 1-Wire kernel modules loaded (AC: 2)
  - [ ] SSH into Raspberry Pi after boot
  - [ ] Check 1-Wire modules loaded: `lsmod | grep w1`
  - [ ] Expected modules: `w1_therm` (temperature sensors) and `w1_gpio` (1-Wire GPIO driver)
  - [ ] If modules not loaded, verify Story 1.3 completion (1-Wire enabled in raspi-config)
  - [ ] Check 1-Wire device detected: `ls -l /sys/bus/w1/devices/`
  - [ ] Expected output: Directory like `28-XXXXXXXXXXXX` (28 = DS18B20 family code)
  - [ ] Document device ID for reference (will be used in test script)

- [ ] Install w1thermsensor Python library (AC: 3)
  - [ ] SSH into Raspberry Pi
  - [ ] Update pip3: `pip3 install --upgrade pip`
  - [ ] Install w1thermsensor: `pip3 install w1thermsensor`
  - [ ] Verify installation: `pip3 list | grep w1thermsensor`
  - [ ] Expected: `w1thermsensor X.X.X` (version number displayed)

- [ ] Create test script for DS18B20 temperature probe (AC: 4)
  - [ ] Create test file: `nano ~/opengardenlab/firmware/tests/test_ds18b20.py`
  - [ ] Write test script code:
    ```python
    #!/usr/bin/env python3
    from w1thermsensor import W1ThermSensor, Unit

    # Initialize DS18B20 sensor (auto-detects first 1-Wire temp sensor)
    sensor = W1ThermSensor()

    print("DS18B20 Waterproof Temperature Probe Test\n")
    print(f"Sensor ID: {sensor.id}")
    print(f"Sensor Type: {sensor.type_name}\n")

    # Read temperature in Celsius
    temp_c = sensor.get_temperature(Unit.DEGREES_C)
    print(f"Soil Temperature: {temp_c:.2f}°C")

    # Read temperature in Fahrenheit
    temp_f = sensor.get_temperature(Unit.DEGREES_F)
    print(f"Soil Temperature: {temp_f:.2f}°F\n")

    print("Test complete!")
    ```
  - [ ] Save and exit nano (Ctrl+X, Y, Enter)
  - [ ] Make script executable: `chmod +x ~/opengardenlab/firmware/tests/test_ds18b20.py`

- [ ] Run test script and validate readings (AC: 5)
  - [ ] Execute test script: `python3 ~/opengardenlab/firmware/tests/test_ds18b20.py`
  - [ ] Verify script runs without errors (no exceptions or tracebacks)
  - [ ] Validate temperature reading is sensible:
    - [ ] Room temperature range: 18-25°C (64-77°F) for indoor testing
    - [ ] Reading should be stable (run script 3 times, readings within ±0.5°C)
    - [ ] Compare with DHT20 air temp from Story 1.4 (should be similar if both indoors)
  - [ ] If reading is nonsensical (e.g., -127°C, 85°C), troubleshoot:
    - [ ] Check pullup resistor installation (4.7kΩ between data and 3.3V)
    - [ ] Verify wiring connections (GPIO4/Pin7 for data line)
    - [ ] Re-check 1-Wire device detection: `ls /sys/bus/w1/devices/`
  - [ ] Document successful test output for story completion

## Dev Notes

### DS18B20 Waterproof Temperature Probe
**Hardware Details** [Source: architecture/hardware-architecture.md]
- **Sensor Type:** DS18B20 - Digital 1-Wire temperature sensor (Maxim Integrated)
- **Form Factor:** Waterproof stainless steel probe (length: 6-12 inches, diameter: 6mm)
- **Temperature Range:** -55°C to +125°C (accurate ±0.5°C from -10°C to +85°C)
- **Resolution:** 9-12 bit configurable (default: 12-bit = 0.0625°C resolution)
- **Advantages:**
  - More accurate than STEMMA Soil's built-in temperature sensor (±0.5°C vs ±1°C)
  - Waterproof design suitable for direct soil insertion
  - Long cable allows sensor placement away from enclosure
  - Low power consumption (~1mA active, 750µA idle)

**1-Wire Protocol** [Source: architecture/hardware-architecture.md]
- **1-Wire Bus:** Single data wire + ground (power can be parasitic or separate VCC)
- **Raspberry Pi 1-Wire Pin:** GPIO4 (Pin 7) - default 1-Wire data pin
- **Pullup Resistor Required:** 4.7kΩ between data line and VCC (3.3V) - ensures proper signal levels
- **Multiple Devices:** Multiple 1-Wire sensors can share same GPIO4 bus (unique ROM IDs)
- **Kernel Modules:**
  - `w1_gpio` - 1-Wire GPIO driver (handles GPIO4 communication)
  - `w1_therm` - 1-Wire temperature sensor driver (DS18B20, DS1820, etc.)

### Wiring Details
**DS18B20 3-Wire Configuration** [Source: architecture/hardware-architecture.md]
- **Red Wire:** VCC (3.3V) - connect to Pin 1 (shared with I2C sensors from Story 1.4)
- **Black Wire:** GND - connect to Pin 6 (shared with I2C sensors from Story 1.4)
- **Yellow Wire:** Data - connect to GPIO4 (Pin 7) - 1-Wire data line
- **Pullup Resistor:** 4.7kΩ resistor between Yellow (GPIO4) and Red (3.3V)
  - **Why needed:** 1-Wire bus is open-drain, pullup resistor pulls line high when idle
  - **Value:** 4.7kΩ is standard for 1-Wire applications (3.3V or 5V systems)
  - **Installation:** Solder or breadboard connection between data pin and VCC

**Shared Power Rails** [Source: architecture/hardware-architecture.md]
- Pin 1 (3.3V) powers: STEMMA Soil, BH1750, DHT20, DS18B20 (all sensors share power)
- Pin 6 (GND) is common ground for all sensors
- No additional power supply needed - Pi's 3.3V rail can supply all 4 sensors (~50mA total)

### Expected 1-Wire Device Detection
**Kernel Module Verification:**
```bash
$ lsmod | grep w1
w1_therm               20480  0
w1_gpio                16384  0
wire                   45056  2 w1_gpio,w1_therm
```
[Source: Story 1.3 - 1-Wire interface enabled]

**Device Detection:**
```bash
$ ls -l /sys/bus/w1/devices/
total 0
lrwxrwxrwx 1 root root 0 Oct  3 10:00 28-0123456789ab -> ../../../devices/w1_bus_master1/28-0123456789ab
lrwxrwxrwx 1 root root 0 Oct  3 10:00 w1_bus_master1 -> ../../../devices/w1_bus_master1
```
- `28-XXXXXXXXXXXX` - DS18B20 device (family code `28`)
- Device ID is unique ROM code (12 hex digits)

**Troubleshooting Missing Device:**
- Check pullup resistor installed (4.7kΩ between data and 3.3V)
- Verify GPIO4 connection (Pin 7)
- Ensure 1-Wire enabled in Story 1.3 (`dtoverlay=w1-gpio` in /boot/config.txt)
- Reboot Raspberry Pi and re-check

### w1thermsensor Python Library
**Library Details** [Source: AC 3]
- **Package:** `w1thermsensor` - High-level Python interface for 1-Wire temperature sensors
- **Installation:** `pip3 install w1thermsensor`
- **Features:**
  - Auto-detection of 1-Wire sensors (scans /sys/bus/w1/devices/)
  - Unit conversion (Celsius, Fahrenheit, Kelvin)
  - Support for multiple sensor types (DS18B20, DS18S20, DS1822, MAX31850K)
  - Asynchronous reading support

**Basic Usage:**
```python
from w1thermsensor import W1ThermSensor, Unit

# Auto-detect first DS18B20 sensor
sensor = W1ThermSensor()

# Read temperature
temp_c = sensor.get_temperature(Unit.DEGREES_C)
temp_f = sensor.get_temperature(Unit.DEGREES_F)
```

**Multiple Sensors:**
```python
# Get all sensors
sensors = W1ThermSensor.get_available_sensors()

# Get specific sensor by ID
sensor = W1ThermSensor(sensor_id="0123456789ab")
```

### Test Script Details
**Purpose:** Validate DS18B20 hardware wiring and library installation before integrating into full firmware service

**Expected Output Example:**
```
DS18B20 Waterproof Temperature Probe Test

Sensor ID: 0123456789ab
Sensor Type: DS18B20

Soil Temperature: 22.45°C
Soil Temperature: 72.41°F

Test complete!
```

**Sensible Value Ranges:** [Source: AC 5]
- **Indoor testing (probe in air):** 18-25°C (64-77°F) - typical room temperature
- **Indoor testing (probe in soil):** 15-25°C (59-77°F) - soil temp usually cooler than air
- **Stability:** Readings should be stable within ±0.5°C over multiple runs
- **Comparison:** DS18B20 should read similar to DHT20 air temp if both indoors (within ±2°C)

**Invalid Readings (indicate hardware/wiring issues):**
- **-127°C or 85°C:** Sensor not detected or communication error (check pullup resistor, wiring)
- **Wildly fluctuating values:** Noise on 1-Wire bus (shorten cable, check pullup resistor value)
- **No reading / timeout:** Device not detected (check /sys/bus/w1/devices/, verify 1-Wire enabled)

### Dependency on Previous Stories
- **Story 1.2 (Pi Setup):** SSH access and Python 3.9+ required
- **Story 1.3 (1-Wire Enable):** 1-Wire interface must be enabled, kernel modules loaded
- **Story 1.4 (I2C Sensors):** Power rails (Pin 1/6) already wired, can share with DS18B20
- **Next Story:** Story 1.6 will create SQLite database to store all sensor readings including DS18B20

### Testing
**Testing Standards for Story 1.5:**
- **Test Type:** Manual hardware integration test (executable test script validates 1-Wire communication)
- **Verification Steps:**
  1. ✅ DS18B20 probe wired to GPIO4 (Pin 7) with 4.7kΩ pullup resistor
  2. ✅ 1-Wire kernel modules loaded (`lsmod | grep w1` shows w1_therm, w1_gpio)
  3. ✅ 1-Wire device detected (`ls /sys/bus/w1/devices/` shows 28-XXXXXXXXXXXX)
  4. ✅ w1thermsensor library installed (`pip3 list | grep w1thermsensor`)
  5. ✅ Test script (`test_ds18b20.py`) created in `firmware/tests/`
  6. ✅ Test script runs without errors (no Python exceptions)
  7. ✅ Temperature reading is sensible (18-25°C for indoor testing, stable within ±0.5°C)
  8. ✅ Reading matches room temperature ±1°C (compare with DHT20 from Story 1.4)
- **Success Criteria:** DS18B20 communicates successfully via 1-Wire, temperature readings are accurate and stable
- **Test Script Location:** `~/opengardenlab/firmware/tests/test_ds18b20.py`
- **No pytest unit tests required** - hardware validation story using executable test script
[Source: architecture/testing-strategy.md - adapted for hardware integration story]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent*
